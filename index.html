<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Generic JSON/CKAN WDC (no popups)</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
  <style>body{font-family:system-ui,Arial;margin:20px}input{width:80%;padding:8px}button{padding:8px 14px;margin-left:8px}</style>
</head>
<body>
  <h2>JSON / CKAN → Tableau (CORS varsa fetch, yoksa CKAN JSONP)</h2>
  <p>Herhangi bir JSON API URL’i (CKAN veya düz JSON):</p>
  <input id="apiUrl" placeholder="https://...">
  <button onclick="submitWDC()">Veriyi Çek</button>

<script>
  // JSONP sadece CKAN datastore_search için denenir
  function jsonp(url, cbName = "__wdcCb_"+Math.random().toString(36).slice(2), timeoutMs=12000){
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      const sep = url.includes('?') ? '&' : '?';
      const full = url + sep + 'callback=' + cbName;
      const timer = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
      function cleanup(){ clearTimeout(timer); delete window[cbName]; s.remove(); }
      window[cbName] = (data)=>{ cleanup(); resolve(data); };
      s.src = full;
      s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
      document.body.appendChild(s);
    });
  }

  async function getJson(url){
    // önce normal fetch dene (CORS açıksa çalışır)
    try{
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){
      // CKAN mı? o zaman JSONP dene
      if (/\/api\/3\/action\/datastore_search/.test(url)) {
        return await jsonp(url);
      }
      // CKAN değilse ve fetch başarısızsa: CORS yüzünden proxy olmadan mümkün değil
      throw e;
    }
  }

  function toTableRows(data){
    // 1) CKAN: result.records
    if (data && data.result && Array.isArray(data.result.records)) return data.result.records;

    // 2) Kökte Dizi
    if (Array.isArray(data)) return data;

    // 3) Nesne içinde dizi ara (ilk bulunan dizi)
    if (data && typeof data === 'object'){
      for (const k of Object.keys(data)){
        if (Array.isArray(data[k])) return data[k];
      }
    }
    return [];
  }

  function inferColumns(rows){
    const sample = rows[0] || {};
    return Object.keys(sample).map(k => ({ id:k, dataType: tableau.dataTypeEnum.string }));
  }

  const connector = tableau.makeConnector();

  connector.getSchema = async function(schemaCallback){
    try{
      const cfg = JSON.parse(tableau.connectionData||'{}');
      const url = cfg.baseUrl;
      const data = await getJson(url);
      const rows = toTableRows(data);
      let cols;
      if (data && data.result && Array.isArray(data.result.fields) && data.result.fields.length){
        // CKAN alanları
        cols = data.result.fields.map(f => ({ id:f.id, dataType: tableau.dataTypeEnum.string }));
      } else {
        cols = inferColumns(rows);
      }
      if (!cols.length) cols = [{ id:'_dummy', dataType: tableau.dataTypeEnum.string }];
      schemaCallback([{ id:'data', alias:'JSON Data', columns: cols }]);
    }catch(e){
      // yine de boş şema döndürmeyelim
      schemaCallback([{ id:'data', alias:'JSON Data (fallback)', columns:[{id:'_dummy', dataType: tableau.dataTypeEnum.string}] }]);
    }
  };

  connector.getData = async function(table, doneCallback){
    try{
      const cfg = JSON.parse(tableau.connectionData||'{}');
      const url = cfg.baseUrl;
      const data = await getJson(url);
      const rows = toTableRows(data);
      if (rows.length) table.appendRows(rows);
      doneCallback();
    }catch(e){
      doneCallback();
    }
  };

  tableau.registerConnector(connector);

  function submitWDC(){
    const u = document.getElementById('apiUrl').value.trim();
    if(!u){ alert('URL girin'); return; }
    tableau.connectionName = 'Generic JSON/CKAN';
    tableau.connectionData  = JSON.stringify({ baseUrl: u });
    tableau.submit();
  }
</script>
</body>
</html>
